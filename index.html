<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dynamic D&amp;D Character Sheet</title>
  <link rel="stylesheet" href="css/styles.css" />
  <meta name="theme-color" content="#0b0d10" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="Icons/app-icon-192.png" />
  <link rel="apple-touch-icon" href="Icons/app-icon-192.png" />
</head>
<body>
  <header class="app-header">
    <div class="app-title">
      <h1>Dynamic D&amp;D Character Sheet</h1>
      <p class="muted">Single-page, local-first, GitHub Pages friendly.</p>
    </div>

    <nav class="tabs" aria-label="Sections" role="tablist">
      <button class="tab" id="tabbtn-sheet" role="tab" data-tab="sheet" aria-controls="tab-sheet" aria-selected="true" tabindex="0">Sheet</button>
      <button class="tab" id="tabbtn-spells" role="tab" data-tab="spells" aria-controls="tab-spells" aria-selected="false" tabindex="-1">Spells</button>
      <button class="tab" id="tabbtn-levelup" role="tab" data-tab="levelup" aria-controls="tab-levelup" aria-selected="false" tabindex="-1">Level Up</button>
      <button class="tab" id="tabbtn-equipment" role="tab" data-tab="equipment" aria-controls="tab-equipment" aria-selected="false" tabindex="-1">Equipment</button>
      <button class="tab" id="tabbtn-rest" role="tab" data-tab="rest" aria-controls="tab-rest" aria-selected="false" tabindex="-1">Rest</button>
      <button class="tab" id="tabbtn-battle" role="tab" data-tab="battle" aria-controls="tab-battle" aria-selected="false" tabindex="-1">Battle</button>
      <button class="tab" id="tabbtn-export" role="tab" data-tab="export" aria-controls="tab-export" aria-selected="false" tabindex="-1">Import/Export</button>
      <button class="tab" id="tabbtn-settings" role="tab" data-tab="settings" aria-controls="tab-settings" aria-selected="false" tabindex="-1">Settings</button>
    </nav>
  </header>

  <main class="app-main">
    <!-- SHEET -->
    <section id="tab-sheet" class="tab-panel" data-tab="sheet" role="tabpanel" aria-labelledby="tabbtn-sheet" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Identity</h2>
          <div class="grid two">
            <label class="field">
              <span>Name</span>
              <input id="name" type="text" placeholder="Character name" />
            </label>
            <label class="field">
              <span>Alignment</span>
              <input id="alignment" type="text" placeholder="Alignment" />
            </label>
          </div>
          <div class="grid two">
            <label class="field">
              <span>Race</span>
              <select id="raceSelect"></select>
            </label>
            <label class="field">
              <span>Background</span>
              <select id="backgroundSelect"></select>
            </label>
          </div>
          <div class="grid two">
            <label class="field">
              <span>Primary class</span>
              <select id="primaryClass"></select>
            </label>
            <label class="field">
              <span>Primary level</span>
              <input id="primaryLevel" type="number" min="0" max="20" />
            </label>
          </div>
          <div class="grid two">
            <label class="field">
              <span>Subclass</span>
              <select id="primarySubclass"></select>
            </label>
            <div class="field">
              <span>Saving throws (from 1st class)</span>
              <div id="saveProfSummary" class="small muted"></div>
              <button id="applyClassSaves" type="button" class="btn">Apply 1st-class saving throws</button>
            </div>
          </div>

          <!-- Warlock-only build: multiclass UI removed -->
        </div>

        <div class="card">
          <h2>Core numbers</h2>
          <div class="grid three">
            <div class="stat">
              <div class="stat-label">Total level</div>
              <div class="stat-value" id="totalLevel">1</div>
            </div>
            <div class="stat">
              <div class="stat-label">Proficiency bonus</div>
              <div class="stat-value" id="pb">+2</div>
            </div>
            <div class="stat">
              <div class="stat-label">Passive Perception</div>
              <div class="stat-value" id="passivePerception">10</div>
            </div>
          </div>

          <div class="grid three mt">
            <label class="field">
              <span>Initiative misc</span>
              <input id="initiativeMisc" type="number" min="-99" max="99" />
            </label>
            <label class="field">
              <span>Perception misc</span>
              <input id="perceptionMisc" type="number" min="-50" max="50" />
            </label>
            <label class="field">
              <span>Inspiration</span>
              <input id="inspirationPoints" type="number" min="0" max="99" />
            </label>
          </div>

          <div class="grid three mt">
            <div class="stat">
              <div class="stat-label">Initiative</div>
              <div class="stat-value" id="initiative">+0</div>
            </div>
            <div class="stat">
              <div class="stat-label">Spell DC</div>
              <div class="stat-value" id="spellDc">8</div>
            </div>
            <div class="stat">
              <div class="stat-label">Spell attack</div>
              <div class="stat-value" id="spellAtk">+0</div>
            </div>
          </div>

          <details class="mt">
            <summary>Spellcasting ability modifiers</summary>
            <div class="grid two">
              <label class="field">
                <span>Primary spell ability mod</span>
                <input id="primarySpellMod" type="number" min="-5" max="15" />
              </label>
              <div></div>
            </div>
            <div class="small muted">These are the ability modifiers (not the scores), e.g. INT 16 means +3.</div>
          </details>
        </div>
      </div>

      <div class="grid two mt">
        <div class="card">
          <h2>Abilities</h2>
          <div id="abilitiesGrid" class="abilities-grid"></div>
          <div class="small muted mt">Ability modifiers and derived bonuses update automatically.</div>
        </div>

        <div class="card">
          <h2>Combat</h2>
          <div class="grid three">
            <label class="field">
              <span>HP max</span>
              <input id="hpMax" type="number" min="0" max="9999" />
            </label>
            <label class="field">
              <span>HP now</span>
              <input id="hpNow" type="number" min="0" max="9999" />
            </label>
            <label class="field">
              <span>Temp HP</span>
              <input id="hpTemp" type="number" min="0" max="9999" />
            </label>
          </div>

          <div class="grid three mt">
            <label class="field">
              <span>AC base</span>
              <input id="acBase" type="number" min="0" max="99" />
            </label>
            <label class="field">
              <span>AC extra</span>
              <input id="acExtra" type="number" min="-20" max="20" />
            </label>
            <div class="stat">
              <div class="stat-label">AC total</div>
              <div class="stat-value" id="acTotal">10</div>
            </div>
          </div>

          <div class="grid three mt">
            <label class="field">
              <span>Speed</span>
              <input id="speed" type="number" min="0" max="999" />
            </label>
            <label class="field">
              <span>Weapon dice</span>
              <input id="weaponDice" type="text" placeholder="e.g. 1d8+3" />
            </label>
            <div class="stat">
              <div class="stat-label">Hit die</div>
              <div class="stat-value" id="hitDie">d8</div>
            </div>
          </div>

          <div class="grid two mt">
            <button id="applyRecommendedHp" type="button" class="btn">Set HP max to recommended average</button>
            <button id="healToFull" type="button" class="btn">Heal to full (HP now = max)</button>
          </div>
        </div>
      </div>

      <div class="grid two mt">
        <div class="card">
          <h2>Saving throws</h2>
          <div id="savesGrid" class="saves-grid"></div>
          <div class="small muted mt">Toggle proficiency, bonus is ability mod + proficiency bonus if proficient.</div>
        </div>

        <div class="card">
          <h2>Skills</h2>
          <div id="skillsTable" class="skills-table"></div>
          <div class="small muted mt">0 = none, 1 = proficient, 2 = expertise.</div>
        </div>
      </div>

      <div class="grid two mt">
        <div class="card">
          <h2>Proficiencies</h2>
          <div class="grid two">
            <div>
              <h3>Tools</h3>
              <div id="toolsList" class="pill-list"></div>
              <div class="grid two mt">
                <input id="toolAdd" type="text" placeholder="Add tool proficiency" />
                <button id="toolAddBtn" class="btn" type="button">Add</button>
              </div>
            </div>
            <div>
              <h3>Languages</h3>
              <div id="langsList" class="pill-list"></div>
              <div class="grid two mt">
                <input id="langAdd" type="text" placeholder="Add language" />
                <button id="langAddBtn" class="btn" type="button">Add</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Features</h2>
          <div id="featuresList" class="feature-list"></div>
          <details class="mt">
            <summary>Add custom feature</summary>
            <div class="grid two mt">
              <input id="featureName" type="text" placeholder="Feature name" />
              <button id="featureAddBtn" class="btn" type="button">Add</button>
            </div>
            <textarea id="featureText" class="mt" rows="4" placeholder="Feature text"></textarea>
          </details>
        </div>
      </div>

      <div class="card mt">
        <h2>Notes</h2>
        <textarea id="notes" rows="6" placeholder="Anything you want to track."></textarea>
      </div>
    </section>

    <!-- SPELLS -->
    <section id="tab-spells" class="tab-panel hidden" data-tab="spells" role="tabpanel" aria-labelledby="tabbtn-spells" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Spell slots</h2>
          <div id="slotsTable"></div>
          <div class="small muted mt">Track expended slots. Long rest resets Spellcasting slots, short rest resets Pact Magic.</div>
        </div>

        <div class="card">
          <h2>Spell limits</h2>
          <div id="spellLimits"></div>
          <div class="small muted mt">Prepared limits depend on the spell ability modifiers in the Sheet tab.</div>
        </div>
      </div>

      <div class="card mt">
        <h2>Spellbook, Known, Prepared</h2>

        <div class="grid two">
          <label class="field">
            <span>Search</span>
            <input id="spellSearch" type="text" placeholder="Type to filter spells by name" />
          </label>
          <label class="field">
            <span>Level filter</span>
            <select id="spellLevelFilter">
              <option value="all">All levels</option>
              <option value="0">Cantrips</option>
              <option value="1">1st</option>
              <option value="2">2nd</option>
              <option value="3">3rd</option>
              <option value="4">4th</option>
              <option value="5">5th</option>
              <option value="6">6th</option>
              <option value="7">7th</option>
              <option value="8">8th</option>
              <option value="9">9th</option>
            </select>
          </label>
        </div>

        <div class="small muted mt" id="spellModeHint"></div>

	        <div id="spellClassRow" class="grid two mt">
	          <label class="field">
	            <span>Spell list class</span>
	            <select id="spellClassSelect"></select>
	          </label>
	          <div class="small muted">If you have multiple classes with spellcasting, choose which class list you are viewing.</div>
	        </div>

        <div id="spellsByLevel"></div>

        <details class="mt">
          <summary>Spell notes</summary>
          <textarea id="spellNotes" rows="5" placeholder="Spell notes (components, prepared rotation, scrolls, etc.)"></textarea>
        </details>
      </div>
    </section>

    <!-- LEVEL UP -->
    <section id="tab-levelup" class="tab-panel hidden" data-tab="levelup" role="tabpanel" aria-labelledby="tabbtn-levelup" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Level Up Wizard</h2>
          <p class="muted small">Leveling, ASI or feat choices, HP rolls, and spell learning happen through the wizard (5e 2014 rules). This prevents changing those choices on the fly.</p>

          <div class="grid two">
            <label class="field">
              <span>Build lock</span>
              <select id="buildLockSelect">
                <option value="locked">Locked (recommended)</option>
                <option value="unlocked">Unlocked (manual edits)</option>
              </select>
            </label>
            <div class="small muted">
              Locked mode disables manual edits for class levels, feat and ASI picks, and known or spellbook spells.
            </div>
          </div>

          <div class="grid two mt">
            <button id="openLevelUpWizardBtn" type="button" class="btn">Level Up...</button>
            <button id="undoLevelUpBtn" type="button" class="btn danger">Undo last level up</button>
          </div>

          <details class="mt">
            <summary>Level up history</summary>
            <div id="buildLog" class="mt"></div>
          </details>

          <details class="mt">
            <summary>Class choices (skills, fighting style, expertise)</summary>
            <div class="small muted mt">
              These choices come from <code>data/class_features.json</code>. Apply them once, then you can still edit Skills/Proficiencies manually.
            </div>
            <div id="classChoicesPanel" class="mt"></div>
          </details>

          <details class="mt">
            <summary>Picks (ASI/Feats)</summary>
            <div class="small muted mt">Earned slots come from your class levels (5e 2014). Choose ASIs/feats inside the Level Up wizard.</div>
            <div id="picksSummary" class="mt"></div>
            <div id="picksEditor" class="mt"></div>
          </details>
        </div>

        <div class="card">
          <h2>Feats</h2>
          <p class="muted small">Feats are granted during Level Up when you earn an ASI or feat choice. This list is for reference.</p>
          <div class="grid two">
            <label class="field">
              <span>Search feats</span>
              <input id="featSearch" type="text" placeholder="Filter by name" />
            </label>
            <label class="field">
              <span>Show</span>
              <select id="featFilter">
                <option value="all">All feats</option>
                <option value="picked">Picked only</option>
                <option value="available">Not picked</option>
              </select>
            </label>
          </div>
          <div id="featsList" class="mt"></div>
        </div>
      </div>
    </section>

    <!-- EQUIPMENT -->
    <section id="tab-equipment" class="tab-panel hidden" data-tab="equipment" role="tabpanel" aria-labelledby="tabbtn-equipment" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Equipment (BG3-style slots)</h2>
          <div class="small muted">Each item can optionally add AC bonus, weapons can set hit dice. Mark one weapon as equipped.</div>
          <div id="equipmentSlots" class="mt"></div>
        </div>

        <div class="card">
          <h2>Inventory</h2>
          <div class="grid two">
            <input id="bagItemName" type="text" placeholder="Item name" />
            <button id="bagAddBtn" type="button" class="btn">Add</button>
          </div>
          <div id="bagList" class="mt"></div>
        </div>
      </div>
    </section>

    <!-- REST -->
    <section id="tab-rest" class="tab-panel hidden" data-tab="rest" role="tabpanel" aria-labelledby="tabbtn-rest" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Short Rest</h2>
          <div class="small muted">Spend hit dice to heal (roll or average). Pact Magic slots reset on short rest.</div>
          <div id="hitDicePools" class="mt"></div>
          <div class="grid three mt">
            <label class="field">
              <span>Mode</span>
              <select id="shortRestMode">
                <option value="roll">Roll</option>
                <option value="average">Average</option>
              </select>
            </label>
            <div></div>
            <button id="shortRestBtn" class="btn" type="button">Apply Short Rest</button>
          </div>
        </div>

        <div class="card">
          <h2>Long Rest</h2>
          <div class="small muted">Restores HP to full, resets hit dice pools, and resets Spellcasting and Pact Magic slots usage.</div>
          <button id="longRestBtn" class="btn" type="button">Apply Long Rest</button>

          <h3 class="mt">Custom resources</h3>
          <div class="small muted">Track anything (Ki, Rage, Inspiration dice, etc.). You control resets.</div>

          <div class="grid two mt">
            <input id="resourceName" type="text" placeholder="Resource name (e.g. Ki)" />
            <button id="resourceAddBtn" class="btn" type="button">Add resource</button>
          </div>
          <div id="resourcesList" class="mt"></div>
        </div>
      </div>
    </section>

    <!-- BATTLE -->
    <section id="tab-battle" class="tab-panel hidden" data-tab="battle" role="tabpanel" aria-labelledby="tabbtn-battle" tabindex="0">
      <div class="card">
        <div class="row">
          <h2>Battle</h2>
          <div class="muted small">Battle tracker module (action economy, HP, spell slots, casting). Syncs with your character sheet both ways.</div>
        </div>
        <iframe id="battleFrame" class="battleFrame" title="Battle Tracker" src="battle.html" loading="lazy"></iframe>
        <div class="muted small mt">
          If you open this directly from your file system and data files cannot load, serve the folder with a local server or GitHub Pages.
        </div>
      </div>
    </section>

    <!-- EXPORT -->
    <section id="tab-export" class="tab-panel hidden" data-tab="export" role="tabpanel" aria-labelledby="tabbtn-export" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Export</h2>
          <p class="muted small">Export your current character state as JSON (for backups or sharing).</p>
          <button id="exportBtn" class="btn" type="button">Generate export</button>
          <textarea id="exportBox" class="mt" rows="16" placeholder="Export will appear here"></textarea>
        </div>

        <div class="card">
          <h2>Import</h2>
          <p class="muted small">Paste a previously exported JSON blob here.</p>
          <textarea id="importBox" class="mt" rows="16" placeholder="Paste JSON here"></textarea>
          <div class="grid two mt">
            <button id="importBtn" class="btn" type="button">Import</button>
            <button id="resetBtn" class="btn danger" type="button">Factory reset</button>
          </div>
          <div id="importStatus" class="small mt"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="tab-panel hidden" data-tab="settings" role="tabpanel" aria-labelledby="tabbtn-settings" tabindex="0">
      <div class="grid two">
        <div class="card">
          <h2>Cloud sync (optional)</h2>
          <p class="muted small">
            Uses Supabase anonymous auth and a single <code>characters</code> table keyed by (user_id, character_id).
            If <code>js/config.js</code> is blank, these buttons are disabled.
          </p>
          <div class="grid two">
            <button id="cloudSaveBtn" class="btn" type="button">Save to cloud</button>
            <button id="cloudLoadBtn" class="btn" type="button">Load from cloud</button>
          </div>
          <div id="cloudStatus" class="small mt"></div>
        </div>

        <div class="card">
          <h2>Data version</h2>
          <div class="small muted" id="dataStatus"></div>

          <h3 class="mt">Developer utilities</h3>
          <button id="recomputeAllBtn" class="btn" type="button">Recompute derived fields</button>
          <div class="small muted mt">
            Mostly useful if you edit JSON data files and want a quick refresh.
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="small muted">
      Local-first. Your character auto-saves to your browser (localStorage). Use Import/Export for backups.
    </div>
  </footer>

  <!-- Level up wizard modal -->
  <dialog id="levelUpDialog" class="modal">
    <div class="modal-card">
      <div class="modal-hdr">
        <div>
          <div class="modal-title">Level Up</div>
          <div class="small muted" id="levelUpSubtitle"></div>
        </div>
        <button id="levelUpCloseBtn" class="btn small" type="button">Close</button>
      </div>

      <div id="levelUpBody" class="mt"></div>

      <div class="modal-footer mt">
        <button id="levelUpBackBtn" class="btn" type="button">Back</button>
        <div class="spacer"></div>
        <button id="levelUpNextBtn" class="btn" type="button">Next</button>
        <button id="levelUpConfirmBtn" class="btn" type="button">Confirm</button>
      </div>
    </div>
  </dialog>

  <script type="module" src="js/app.js"></script>
</body>
</html>
